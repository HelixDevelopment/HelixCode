version: '3.8'

services:
  # Main HelixCode server for testing
  helixcode-server:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
      - "2222:22"  # SSH port for worker connections
    environment:
      - HELIX_ENV=test
      - HELIX_DATABASE_URL=postgres://helix:helixpass@postgres:5432/helixcode_test?sslmode=disable
      - HELIX_REDIS_URL=redis://redis:6379
      - HELIX_SSH_HOST_KEY=/etc/ssh/ssh_host_rsa_key
    volumes:
      - ./test/ssh-keys:/root/.ssh:ro
      - ./test/config:/etc/helixcode:ro
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - helixcode-test
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # PostgreSQL database for testing
  postgres:
    image: postgres:15
    environment:
      - POSTGRES_DB=helixcode_test
      - POSTGRES_USER=helix
      - POSTGRES_PASSWORD=helixpass
    ports:
      - "5432:5432"
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
      - ./test/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - helixcode-test
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U helix"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis cache for testing
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    networks:
      - helixcode-test
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Worker node 1 - CPU focused
  worker-1:
    build:
      context: .
      dockerfile: Dockerfile.worker
    hostname: worker-1
    environment:
      - WORKER_ID=worker-1
      - WORKER_CAPABILITIES=code-generation,testing,python-execution
      - WORKER_MAX_TASKS=5
      - HELIX_SERVER=helixcode-server:2222
    volumes:
      - ./test/ssh-keys:/root/.ssh:ro
    depends_on:
      helixcode-server:
        condition: service_healthy
    networks:
      - helixcode-test
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G

  # Worker node 2 - GPU focused (simulated)
  worker-2:
    build:
      context: .
      dockerfile: Dockerfile.worker
    hostname: worker-2
    environment:
      - WORKER_ID=worker-2
      - WORKER_CAPABILITIES=llm-inference,model-training,cuda-computation
      - WORKER_MAX_TASKS=3
      - HELIX_SERVER=helixcode-server:2222
      - SIMULATE_GPU=true
    volumes:
      - ./test/ssh-keys:/root/.ssh:ro
    depends_on:
      helixcode-server:
        condition: service_healthy
    networks:
      - helixcode-test
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '2.0'
          memory: 2G

  # Worker node 3 - High memory
  worker-3:
    build:
      context: .
      dockerfile: Dockerfile.worker
    hostname: worker-3
    environment:
      - WORKER_ID=worker-3
      - WORKER_CAPABILITIES=data-processing,analysis,docker-execution
      - WORKER_MAX_TASKS=2
      - HELIX_SERVER=helixcode-server:2222
    volumes:
      - ./test/ssh-keys:/root/.ssh:ro
    depends_on:
      helixcode-server:
        condition: service_healthy
    networks:
      - helixcode-test
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 8G
        reservations:
          cpus: '0.5'
          memory: 4G

  # Test runner for unit and integration tests
  test-runner:
    build:
      context: .
      dockerfile: Dockerfile.test
    environment:
      - HELIX_SERVER=helixcode-server:8080
      - POSTGRES_URL=postgres://helix:helixpass@postgres:5432/helixcode_test?sslmode=disable
      - REDIS_URL=redis://redis:6379
      - WORKER_1_HOST=worker-1
      - WORKER_2_HOST=worker-2
      - WORKER_3_HOST=worker-3
    volumes:
      - .:/workspace
      - /var/run/docker.sock:/var/run/docker.sock
    working_dir: /workspace
    depends_on:
      - helixcode-server
      - postgres
      - redis
      - worker-1
      - worker-2
      - worker-3
    networks:
      - helixcode-test
    command: ["go", "test", "-v", "./internal/worker/..."]

  # E2E test runner
  e2e-test-runner:
    build:
      context: .
      dockerfile: Dockerfile.test
    environment:
      - HELIX_SERVER=helixcode-server:8080
      - POSTGRES_URL=postgres://helix:helixpass@postgres:5432/helixcode_test?sslmode=disable
      - REDIS_URL=redis://redis:6379
      - WORKER_1_HOST=worker-1
      - WORKER_2_HOST=worker-2
      - WORKER_3_HOST=worker-3
    volumes:
      - .:/workspace
      - /var/run/docker.sock:/var/run/docker.sock
    working_dir: /workspace
    depends_on:
      - helixcode-server
      - postgres
      - redis
      - worker-1
      - worker-2
      - worker-3
    networks:
      - helixcode-test
    command: ["go", "test", "-v", "./test/e2e/...", "-tags=e2e"]

volumes:
  postgres_test_data:

networks:
  helixcode-test:
    driver: bridge